### ะะฝััััะบัะธั ะฟะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั ัะบัะธะฟัะพะฒ ัะฟัะฐะฒะปะตะฝะธั PostgreSQL

#### ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
postgres/
โโโ 01_postgresql_cluster_setup.md
โโโ 02_postgresql_schemas_convention.md
โโโ db_manage/
    โโโ create-all-staging-schemas.sh
    โโโ create-schema.sh
    โโโ delete-schema.sh
    โโโ test-schema-permissions.sh
    โโโ postgres-schema-script-instruction.md
```

---

#### ะะฟะธัะฐะฝะธะต ัะบัะธะฟัะพะฒ

ะะฐะฑะพั ัะบัะธะฟัะพะฒ ะดะปั ะฐะฒัะพะผะฐัะธะทะฐัะธะธ ัะฐะฑะพัั ั PostgreSQL ััะตะผะฐะผะธ ะฒ Selectel Managed Databases:

##### 1. `create-schema.sh`
ะกะพะทะดะฐะฝะธะต ััะตะผั, ะฒัะดะฐัะฐ ะฟัะฐะฒ ะฟะพะปัะทะพะฒะฐัะตะปั ะธ ัะพะทะดะฐะฝะธะต Kubernetes Secret

**ะงัะพ ะดะตะปะฐะตั:**
- ะกะพะทะดะฐัั ััะตะผั ะฒ PostgreSQL
- ะัะดะฐัั ะฟัะฐะฒะฐ ะฟะพะปัะทะพะฒะฐัะตะปั (ัะพะทะดะฐะฝะฝะพะผั ัะตัะตะท ะฟะฐะฝะตะปั Selectel)
- ะะฐัััะฐะธะฒะฐะตั ะธะทะพะปััะธั (ะทะฐะฟัะตัะฐะตั ะดะพัััะฟ ะบ public ะธ ัะพะทะดะฐะฝะธะต ะฝะพะฒัั ััะตะผ)
- ะกะพะทะดะฐัั Kubernetes Secret ั ะดะฐะฝะฝัะผะธ ะฟะพะดะบะปััะตะฝะธั

##### 2. `delete-schema.sh`
ะฃะดะฐะปะตะฝะธะต ััะตะผั ะธ ัะฒัะทะฐะฝะฝัั ัะตััััะพะฒ

**ะงัะพ ะดะตะปะฐะตั:**
- ะฃะดะฐะปัะตั ััะตะผั ัะพ ะฒัะตะผะธ ะพะฑัะตะบัะฐะผะธ (CASCADE)
- ะฃะดะฐะปัะตั Kubernetes Secret
- ะะฐะฟะพะผะธะฝะฐะตั ัะดะฐะปะธัั ะฟะพะปัะทะพะฒะฐัะตะปั ัะตัะตะท ะฟะฐะฝะตะปั Selectel

##### 3. `test-schema-permissions.sh`
ะะพะผะฟะปะตะบัะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต ะฟัะฐะฒ ะฟะพะปัะทะพะฒะฐัะตะปั PostgreSQL

**ะงัะพ ะดะตะปะฐะตั:**
- ะัะพะฒะตััะตั ะฑะฐะทะพะฒะพะต ะฟะพะดะบะปััะตะฝะธะต
- ะขะตััะธััะตั CRUD ะพะฟะตัะฐัะธะธ (CREATE, INSERT, SELECT, UPDATE, DELETE)
- ะัะพะฒะตััะตั ัะฐะฑะพัั ั ะธะฝะดะตะบัะฐะผะธ ะธ ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพัััะผะธ
- ะขะตััะธััะตั ะธะทะพะปััะธั ะพั ะดััะณะธั ััะตะผ
- ะัะพะฒะตััะตั ะพะณัะฐะฝะธัะตะฝะธั (ะทะฐะฟัะตั CREATE SCHEMA, CREATE USER, DROP ะดััะณะธั ััะตะผ)
- ะัะพะฒะตััะตั ะดะพัััะฟ ะบ ะผะตัะฐะดะฐะฝะฝัะผ (information_schema)

##### 4. `create-all-staging-schemas.sh`
ะะฐััะพะฒะพะต ัะพะทะดะฐะฝะธะต ััะตะผ ะดะปั ะฒัะตั ัะตัะฒะธัะพะฒ ะฒ ะพะบััะถะตะฝะธะธ staging

**ะัะพะฑะตะฝะฝะพััะธ:**
- ะะพะปัะทะพะฒะฐัะตะปะธ PostgreSQL ัะพะทะดะฐัััั ะฒัััะฝัั ัะตัะตะท ะฟะฐะฝะตะปั Selectel (ะพะณัะฐะฝะธัะตะฝะธะต managed databases)
- ะกะบัะธะฟั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพะฟัะตะดะตะปัะตั ัััะตััะฒัััะธะต ััะตะผั ะธ ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- ะะพะดะดะตัะถะบะฐ ะพะฑะฝะพะฒะปะตะฝะธั ะฟะฐัะพะปะตะน

---

#### ะขัะตะฑะพะฒะฐะฝะธั

- โ `kubectl` ั ะดะพัััะฟะพะผ ะบ Kubernetes ะบะปะฐััะตัั
- โ Kubernetes Secret `postgres-creds` ะฒ namespace `bastion`
- โ Deployment `bastion` ะทะฐะฟััะตะฝ ะธ ัะฐะฑะพัะฐะตั
- โ ะะพัััะฟ ะบ ะฒะตะฑ-ะฟะฐะฝะตะปะธ Selectel ะดะปั ัะพะทะดะฐะฝะธั/ัะดะฐะปะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- โ `bash` ะฒะตััะธะธ 4.0+

---

#### Naming Convention

##### ะกัะตะผั
ะคะพัะผะฐั: `{service_name}_{environment}`

ะัะธะผะตัั:
- `auth_service_staging`
- `profile_service_prod`
- `project_service_staging`

##### ะะพะปัะทะพะฒะฐัะตะปะธ
ะคะพัะผะฐั: `{service_name}_{environment}_app`

ะัะธะผะตัั:
- `auth_service_staging_app`
- `profile_service_prod_app`

##### Kubernetes Secrets
ะคะพัะผะฐั: `postgres-{service-name}-{environment}-app`

ะัะธะผะตัั:
- `postgres-auth-service-staging-app`
- `postgres-profile-service-prod-app`

**ะะฐะถะฝะพ:** ะ ะฝะฐะทะฒะฐะฝะธัั Secret ะฟะพะดัััะบะธะฒะฐะฝะธั ะทะฐะผะตะฝััััั ะฝะฐ ะดะตัะธัั.

---

#### ะกะพะทะดะฐะฝะธะต ััะตะผั ะธ ะฟะพะปัะทะพะฒะฐัะตะปั

##### ะฃััะฐะฝะพะฒะบะฐ

```bash
cd postgres/db_manage
chmod +x create-schema.sh
```

##### ะัะฟะพะปัะทะพะฒะฐะฝะธะต

```bash
./create-schema.sh <service_name> <environment>
```

**ะะฐัะฐะผะตััั:**
- `service_name` โ ะธะผั ัะตัะฒะธัะฐ (ะฝะฐะฟัะธะผะตั: `auth_service`, `profile_service`)
- `environment` โ ะพะบััะถะตะฝะธะต (`staging` ะธะปะธ `prod`)

##### ะัะธะผะตัั

```bash
# ะกะพะทะดะฐะฝะธะต ััะตะผั ะดะปั auth_service ะฒ staging
./create-schema.sh auth_service staging

# ะกะพะทะดะฐะฝะธะต ััะตะผั ะดะปั profile_service ะฒ production
./create-schema.sh profile_service prod

# ะะฑะฝะพะฒะปะตะฝะธะต ะฟะฐัะพะปั ะดะปั ัััะตััะฒัััะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั
./create-schema.sh auth_service staging
# ะกะบัะธะฟั ะพะฟัะตะดะตะปะธั, ััะพ ััะตะผะฐ ะธ ะฟะพะปัะทะพะฒะฐัะตะปั ัััะตััะฒััั
# ะธ ะฟัะตะดะปะพะถะธั ะพะฑะฝะพะฒะธัั ะฟะฐัะพะปั
```

---

##### Workflow ัะบัะธะฟัะฐ

###### ะจะฐะณ 1: ะัะพะฒะตัะบะฐ ะฟะฐัะฐะผะตััะพะฒ ะธ ัะพัะผะธัะพะฒะฐะฝะธะต ะธะผัะฝ

ะกะบัะธะฟั ะฟะพะบะฐะถะตั, ััะพ ะฑัะดะตั ัะพะทะดะฐะฝะพ:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โน ะกะพะทะดะฐะฝะธะต ะธะฝััะฐััััะบัััั ะดะปั ัะตัะฒะธัะฐ: auth_service
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ะัะดะตั ัะพะทะดะฐะฝะพ:

  ๐๏ธ  PostgreSQL:
      ะกัะตะผะฐ:        auth_service_staging
      ะะพะปัะทะพะฒะฐัะตะปั: auth_service_staging_app

  ๐ Kubernetes:
      Secret:    postgres-auth-service-staging-app
      Namespace: postgres

ะัะพะดะพะปะถะธัั? (y/n):
```

ะะฐะถะผะธัะต `y` ะดะปั ะฟัะพะดะพะปะถะตะฝะธั.

---

###### ะจะฐะณ 2: ะัะพะฒะตัะบะฐ ะธ ัะพะทะดะฐะฝะธะต ััะตะผั ะฒ PostgreSQL

**ะกะปััะฐะน 1: ะกัะตะผะฐ ะฝะต ัััะตััะฒัะตั**

```
โถ ะจะฐะณ 2/5: ะัะพะฒะตัะบะฐ ะธ ัะพะทะดะฐะฝะธะต ััะตะผั ะฒ PostgreSQL...

โ ะกัะตะผะฐ 'auth_service_staging' ัะพะทะดะฐะฝะฐ
```

**ะกะปััะฐะน 2: ะกัะตะผะฐ ัะถะต ัััะตััะฒัะตั**

```
โถ ะจะฐะณ 2/5: ะัะพะฒะตัะบะฐ ะธ ัะพะทะดะฐะฝะธะต ััะตะผั ะฒ PostgreSQL...

โ ะกัะตะผะฐ 'auth_service_staging' ัะถะต ัััะตััะฒัะตั

ะกัะตะผะฐ ัะถะต ัะพะทะดะฐะฝะฐ. ะัะพะดะพะปะถะธัั ั ะฒัะดะฐัะตะน ะฟัะฐะฒ ะธ ัะพะทะดะฐะฝะธะตะผ Secret? (y/n):
```

ะะฐะถะผะธัะต `y` ะดะปั ะฟัะพะดะพะปะถะตะฝะธั ะธะปะธ `n` ะดะปั ะพัะผะตะฝั.

---

###### ะจะฐะณ 3: ะัะพะฒะตัะบะฐ ะฟะพะปัะทะพะฒะฐัะตะปั PostgreSQL

**ะกะปััะฐะน 1: ะะพะปัะทะพะฒะฐัะตะปั ะฝะต ัััะตััะฒัะตั**

ะกะบัะธะฟั ะฒัะฒะตะดะตั ะธะฝััััะบัะธั ะฟะพ ัะพะทะดะฐะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั ัะตัะตะท ะฟะฐะฝะตะปั Selectel (ัะผ. ะฝะธะถะต).

**ะกะปััะฐะน 2: ะะพะปัะทะพะฒะฐัะตะปั ัะถะต ัััะตััะฒัะตั**

```
โถ ะจะฐะณ 3/5: ะัะพะฒะตัะบะฐ ะฟะพะปัะทะพะฒะฐัะตะปั PostgreSQL...

โ ะะพะปัะทะพะฒะฐัะตะปั 'auth_service_staging_app' ัะถะต ัััะตััะฒัะตั

ะะฑะฝะพะฒะธัั ะฟะฐัะพะปั ะฟะพะปัะทะพะฒะฐัะตะปั? (y/n):
```

- ะะฐะถะผะธัะต `y` โ ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั ะฟะฐัะพะปั
- ะะฐะถะผะธัะต `n` โ ะดะปั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ัะตะบััะตะณะพ ะฟะฐัะพะปั

---

###### ะจะฐะณ 3a: ะกะพะทะดะฐะฝะธะต ะฝะพะฒะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั (ะตัะปะธ ะฝะต ัััะตััะฒัะตั)

**ะกะบัะธะฟั ะพััะฐะฝะฐะฒะปะธะฒะฐะตััั** ะธ ะฒัะฒะพะดะธั ะธะฝััััะบัะธั:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะขะะะะฃะะขะกะฏ ะะฃะงะะะ ะะะะกะขะะะ: ะกะพะทะดะฐะนัะต ะฟะพะปัะทะพะฒะฐัะตะปั ัะตัะตะท ะฟะฐะฝะตะปั Selectel
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ๏ธ  ะ Selectel Managed Databases ะฟะพะปัะทะพะฒะฐัะตะปะธ ัะพะทะดะฐัััั ัะพะปัะบะพ ัะตัะตะท ะฒะตะฑ-ะฟะฐะฝะตะปั.

๐ ะะฝััััะบัะธั ะฟะพ ัะพะทะดะฐะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั:

  1๏ธโฃ  ะัะบัะพะนัะต ะฟะฐะฝะตะปั ัะฟัะฐะฒะปะตะฝะธั Selectel:
      my.selectel.ru โ Cloud Platform โ Managed Databases

  2๏ธโฃ  ะัะฑะตัะธัะต ะฒะฐั PostgreSQL ะบะปะฐััะตั

  3๏ธโฃ  ะะตัะตะนะดะธัะต ะฝะฐ ะฒะบะปะฐะดะบั ยซะะพะปัะทะพะฒะฐัะตะปะธยป

  4๏ธโฃ  ะะฐะถะผะธัะต ะบะฝะพะฟะบั ยซะกะพะทะดะฐัั ะฟะพะปัะทะพะฒะฐัะตะปัยป

  5๏ธโฃ  ะะฐะฟะพะปะฝะธัะต ัะพัะผั:
      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ ะะผั ะฟะพะปัะทะพะฒะฐัะตะปั: auth_service_staging_app      โ
      โ ะะฐัะพะปั:           [ะฟัะธะดัะผะฐะนัะต ะฝะฐะดัะถะฝัะน ะฟะฐัะพะปั]  โ
      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

  6๏ธโฃ  ะัะดะฐะนัะต ะดะพัััะฟ ะบ ะฑะฐะทะต ะดะฐะฝะฝัั:
      ะ ัะฐะทะดะตะปะต ยซะะผะตัั ะดะพัััะฟยป ะฒัะฑะตัะธัะต ะฑะฐะทั: db_main

  7๏ธโฃ  ะะฐะถะผะธัะต ยซะกะพะทะดะฐััยป

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ ะกะบัะธะฟั ะฟัะธะพััะฐะฝะพะฒะปะตะฝ. ะะพัะปะต ัะพะทะดะฐะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะผะธัะต Enter...
```

**ะะตะนััะฒะธั:**
1. ะกะพะทะดะฐะนัะต ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ะฟะฐะฝะตะปะธ Selectel
2. ะกะพััะฐะฝะธัะต ะฟะฐัะพะปั
3. ะะฐะถะผะธัะต **Enter** ะฒ ัะตัะผะธะฝะฐะปะต

---

###### ะจะฐะณ 4: ะะฒะพะด ะฟะฐัะพะปั

**ะะปั ะฝะพะฒะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั:**
```
โน ะะฒะตะดะธัะต ะฟะฐัะพะปั ะฟะพะปัะทะพะฒะฐัะตะปั auth_service_staging_app:

ะะฐัะพะปั: ********
```

**ะะปั ะพะฑะฝะพะฒะปะตะฝะธั ะฟะฐัะพะปั:**
```
โน ะะฒะตะดะธัะต ะฝะพะฒัะน ะฟะฐัะพะปั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั auth_service_staging_app:

ะะฐัะพะปั: ********
```

ะะฒะตะดะธัะต ะฟะฐัะพะปั (ัะธะผะฒะพะปั ะฝะต ะพัะพะฑัะฐะถะฐัััั) ะธ ะฝะฐะถะผะธัะต **Enter**.

---

###### ะจะฐะณ 4a: ะะฑะฝะพะฒะปะตะฝะธะต ะฟะฐัะพะปั ะฒ Selectel (ะตัะปะธ ะฒัะฑัะฐะฝะพ ะพะฑะฝะพะฒะปะตะฝะธะต)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะขะะะะฃะะขะกะฏ ะะฃะงะะะ ะะะะกะขะะะ: ะะฑะฝะพะฒะธัะต ะฟะฐัะพะปั ัะตัะตะท ะฟะฐะฝะตะปั Selectel
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ะะฝััััะบัะธั:

  1๏ธโฃ  ะัะบัะพะนัะต ะฟะฐะฝะตะปั Selectel โ Managed Databases โ ะฒะฐั ะบะปะฐััะตั
  2๏ธโฃ  ะะบะปะฐะดะบะฐ ยซะะพะปัะทะพะฒะฐัะตะปะธยป โ ะฝะฐะนะดะธัะต auth_service_staging_app
  3๏ธโฃ  ะะฐะถะผะธัะต ะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปั ะดะปั ัะตะดะฐะบัะธัะพะฒะฐะฝะธั
  4๏ธโฃ  ะะฑะฝะพะฒะธัะต ะฟะฐัะพะปั ะฝะฐ ัะพั, ััะพ ะฒั ัะพะปัะบะพ ััะพ ะฒะฒะตะปะธ
  5๏ธโฃ  ะกะพััะฐะฝะธัะต ะธะทะผะตะฝะตะฝะธั

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ ะะพัะปะต ะพะฑะฝะพะฒะปะตะฝะธั ะฟะฐัะพะปั ะฝะฐะถะผะธัะต Enter...
```

**ะะตะนััะฒะธั:**
1. ะะฑะฝะพะฒะธัะต ะฟะฐัะพะปั ะฒ ะฟะฐะฝะตะปะธ Selectel
2. ะะฐะถะผะธัะต **Enter** ะฒ ัะตัะผะธะฝะฐะปะต

---

###### ะจะฐะณ 5: ะัะดะฐัะฐ ะฟัะฐะฒ

```
โถ ะจะฐะณ 4/5: ะัะดะฐัะฐ ะฟัะฐะฒ ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐ ััะตะผั...

โ ะัะฐะฒะฐ ะฝะฐ ััะตะผั 'auth_service_staging' ะฒัะดะฐะฝั ะฟะพะปัะทะพะฒะฐัะตะปั 'auth_service_staging_app'

โ ะะพะดะบะปััะตะฝะธะต ััะฟะตัะฝะพ (ะฟะพะปัะทะพะฒะฐัะตะปั: auth_service_staging_app)
```

**ะัะดะฐะฝะฝัะต ะฟัะฐะฒะฐ:**
- `USAGE, CREATE` ะฝะฐ ััะตะผั
- `ALL PRIVILEGES` ะฝะฐ ัะฐะฑะปะธัั, ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ, ััะฝะบัะธะธ
- `REVOKE CREATE` ะฝะฐ ะฑะฐะทะต ะดะฐะฝะฝัั (ะทะฐะฟัะตั ัะพะทะดะฐะฝะธั ะฝะพะฒัั ััะตะผ)
- `REVOKE ALL` ะฝะฐ ััะตะผะต public (ะธะทะพะปััะธั)

---

###### ะจะฐะณ 6: ะกะพะทะดะฐะฝะธะต ะธะปะธ ะพะฑะฝะพะฒะปะตะฝะธะต Kubernetes Secret

```
โถ ะจะฐะณ 5/5: ะกะพะทะดะฐะฝะธะต Kubernetes Secret...

โ Kubernetes Secret 'postgres-auth-service-staging-app' ัะพะทะดะฐะฝ ะฒ namespace 'postgres'
```

ะัะปะธ ะฟะฐัะพะปั ะพะฑะฝะพะฒะปัะปัั:
```
โ Secret 'postgres-auth-service-staging-app' ัะถะต ัััะตััะฒัะตั
โน Secret ะฑัะดะตั ะพะฑะฝะพะฒะปัะฝ ั ะฝะพะฒัะผ ะฟะฐัะพะปะตะผ

โ Kubernetes Secret 'postgres-auth-service-staging-app' ัะพะทะดะฐะฝ ะฒ namespace 'postgres'
```

---

##### ะัะพะณะพะฒัะน ัะตะทัะปััะฐั

**ะะปั ะฝะพะฒะพะน ะธะฝััะฐััััะบัััั:**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะะฝััะฐััััะบัััะฐ ััะฟะตัะฝะพ ัะพะทะดะฐะฝะฐ!
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ะะตะทัะปััะฐั:

  ๐๏ธ  PostgreSQL:
      ะกัะตะผะฐ:        auth_service_staging (ัะพะทะดะฐะฝะฐ)
      ะะพะปัะทะพะฒะฐัะตะปั:  auth_service_staging_app (ัะพะทะดะฐะฝ)
      ะัะฐะฒะฐ:        โ CREATE ะพะฑัะตะบัะพะฒ ะฒ ัะฒะพะตะน ััะตะผะต
                    โ CREATE ะฝะพะฒัั ััะตะผ ะทะฐะฟัะตััะฝ
                    โ ะะพัััะฟ ะบ ััะตะผะต public ะทะฐะฟัะตััะฝ

  ๐ Kubernetes Secret:
      ะะฐะทะฒะฐะฝะธะต:     postgres-auth-service-staging-app
      Namespace:    postgres

  โ ะะพัััะฟะฝัะต ะบะปััะธ ะฒ Secret:
      โข host
      โข port
      โข dbname
      โข user
      โข password
      โข schema

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ะกะปะตะดัััะธะต ัะฐะณะธ:

  1๏ธโฃ  ะัะพะฒะตัะธัั ะฟัะฐะฒะฐ ะฟะพะปัะทะพะฒะฐัะตะปั:
     ./test-schema-permissions.sh auth_service staging

  2๏ธโฃ  ะัะพะฒะตัะธัั ัะพะทะดะฐะฝะฝัะน Secret:
     kubectl get secret postgres-auth-service-staging-app -n postgres

  3๏ธโฃ  ะัะพัะผะพััะตัั ัะพะดะตัะถะธะผะพะต Secret:
     kubectl get secret postgres-auth-service-staging-app -n postgres -o yaml
```

---

#### ะขะตััะธัะพะฒะฐะฝะธะต ะฟัะฐะฒ ะฟะพะปัะทะพะฒะฐัะตะปั

ะะพัะปะต ัะพะทะดะฐะฝะธั ััะตะผั **ะพะฑัะทะฐัะตะปัะฝะพ** ะทะฐะฟัััะธัะต ัะตััั:

```bash
./test-schema-permissions.sh auth_service staging
```

##### ะงัะพ ะฟัะพะฒะตััะตััั

###### ะะฐัะตะณะพัะธั 1: ะะฐะทะพะฒะพะต ะฟะพะดะบะปััะตะฝะธะต
- ะะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต ะดะฐะฝะฝัั
- ะัะพะฒะตัะบะฐ ัะตะบััะตะน ััะตะผั

###### ะะฐัะตะณะพัะธั 2: READ/WRITE ะฟัะฐะฒะฐ
- CREATE TABLE ะฒ ัะฒะพะตะน ััะตะผะต
- INSERT ะดะฐะฝะฝัั
- SELECT ะดะฐะฝะฝัั
- UPDATE ะดะฐะฝะฝัั
- DELETE ะดะฐะฝะฝัั
- CREATE INDEX
- DROP TABLE

###### ะะฐัะตะณะพัะธั 3: ะะฐะฑะพัะฐ ั SEQUENCES
- CREATE SEQUENCE
- ะัะฟะพะปัะทะพะฒะฐะฝะธะต SEQUENCE (nextval)
- DROP SEQUENCE

###### ะะฐัะตะณะพัะธั 4: ะะทะพะปััะธั ะพั ะดััะณะธั ััะตะผ
- ะะพะฟััะบะฐ CREATE TABLE ะฒ ะดััะณะพะน ััะตะผะต (ะดะพะปะถะฝะฐ ะฟัะพะฒะฐะปะธัััั)
- ะะพะฟััะบะฐ SELECT ะธะท ะดััะณะพะน ััะตะผั (ะดะพะปะถะฝะฐ ะฟัะพะฒะฐะปะธัััั)

###### ะะฐัะตะณะพัะธั 5: ะะณัะฐะฝะธัะตะฝะธั ััะฟะตัะฟะพะปัะทะพะฒะฐัะตะปั
- ะะพะฟััะบะฐ CREATE SCHEMA (ะดะพะปะถะฝะฐ ะฟัะพะฒะฐะปะธัััั)
- ะะพะฟััะบะฐ CREATE USER (ะดะพะปะถะฝะฐ ะฟัะพะฒะฐะปะธัััั)
- ะะพะฟััะบะฐ DROP ััะตะผั public (ะดะพะปะถะฝะฐ ะฟัะพะฒะฐะปะธัััั)

###### ะะฐัะตะณะพัะธั 6: ะะพัััะฟ ะบ ะผะตัะฐะดะฐะฝะฝัะผ
- ะงัะตะฝะธะต ัะฒะพะตะน ััะตะผั ะธะท information_schema
- ะัะพัะผะพัั ัะฒะพะธั ัะฐะฑะปะธั

##### ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะะขะะะะะะฏ ะกะขะะขะะกะขะะะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

  ะัะตะณะพ ัะตััะพะฒ: 15
  ะัะพะนะดะตะฝะพ:     15
  ะัะพะฒะฐะปะตะฝะพ:    0

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะะกะ ะขะะกะขะซ ะะะะะะะะซ! โจ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ ะะพะดัะฒะตัะถะดะตะฝะพ:
  โข ะะพะปัะทะพะฒะฐัะตะปั ะธะผะตะตั ะฟะพะปะฝัะน ะดะพัััะฟ ะบ ัะฒะพะตะน ััะตะผะต
  โข ะะพะปัะทะพะฒะฐัะตะปั ะะ ะธะผะตะตั ะดะพัััะฟะฐ ะบ ะดััะณะธะผ ััะตะผะฐะผ
  โข ะะพะปัะทะพะฒะฐัะตะปั ะะ ะผะพะถะตั ัะพะทะดะฐะฒะฐัั ััะตะผั/ะฟะพะปัะทะพะฒะฐัะตะปะตะน
  โข ะัะฐะฒะฐ ะฝะฐัััะพะตะฝั ะบะพััะตะบัะฝะพ ัะพะณะปะฐัะฝะพ ะฟัะธะฝัะธะฟั least privilege
```

---

#### ะฃะดะฐะปะตะฝะธะต ััะตะผั ะธ ะฟะพะปัะทะพะฒะฐัะตะปั

##### ะัะฟะพะปัะทะพะฒะฐะฝะธะต

```bash
./delete-schema.sh <service_name> <environment>
```

##### ะัะธะผะตัั

```bash
# ะฃะดะฐะปะตะฝะธะต ััะตะผั auth_service ะฒ staging
./delete-schema.sh auth_service staging

# ะฃะดะฐะปะตะฝะธะต ััะตะผั profile_service ะฒ production
./delete-schema.sh profile_service prod
```

---

##### Workflow ัะบัะธะฟัะฐ ัะดะฐะปะตะฝะธั

###### ะจะฐะณ 1: ะะพะดัะฒะตัะถะดะตะฝะธะต

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะฃะะะะะะะ ะธะฝััะฐััััะบัััั ะดะปั ัะตัะฒะธัะฐ: auth_service
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ๏ธ  ะัะดะตั ัะดะฐะปะตะฝะพ:

  ๐๏ธ  PostgreSQL:
      ะกัะตะผะฐ:        auth_service_staging (ะฒะบะปััะฐั ะฒัะต ัะฐะฑะปะธัั)

  ๐ Kubernetes:
      Secret:    postgres-auth-service-staging-app
      Namespace: postgres

  ๐ค ะะพะปัะทะพะฒะฐัะตะปั PostgreSQL:
      auth_service_staging_app (ััะตะฑัะตััั ัะดะฐะปะธัั ะฒัััะฝัั ัะตัะตะท Selectel)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ ะญัะพ ะดะตะนััะฒะธะต ะะะะะะะขะะะ! ะัะต ะดะฐะฝะฝัะต ะฒ ััะตะผะต ะฑัะดัั ะฟะพัะตััะฝั.

ะั ัะฒะตัะตะฝั? ะะฒะตะดะธัะต 'yes' ะดะปั ะฟะพะดัะฒะตัะถะดะตะฝะธั:
```

ะะฒะตะดะธัะต `yes` ะดะปั ะฟะพะดัะฒะตัะถะดะตะฝะธั.

---

###### ะจะฐะณ 2: ะฃะดะฐะปะตะฝะธะต ััะตะผั ะธ Secret

```
โน ะฃะดะฐะปะตะฝะธะต ััะตะผั 'auth_service_staging'...
โ ะกัะตะผะฐ 'auth_service_staging' ัะดะฐะปะตะฝะฐ

โน ะฃะดะฐะปะตะฝะธะต Kubernetes Secret...
โ Secret 'postgres-auth-service-staging-app' ัะดะฐะปัะฝ
```

---

###### ะจะฐะณ 3: ะะฝััััะบัะธั ะฟะพ ัะดะฐะปะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะขะะะะฃะะขะกะฏ ะะฃะงะะะ ะะะะกะขะะะ: ะฃะดะฐะปะธัะต ะฟะพะปัะทะพะฒะฐัะตะปั ัะตัะตะท ะฟะฐะฝะตะปั Selectel
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ค ะะพะปัะทะพะฒะฐัะตะปั: auth_service_staging_app

ะะฝััััะบัะธั:

  1๏ธโฃ  ะัะบัะพะนัะต ะฟะฐะฝะตะปั ัะฟัะฐะฒะปะตะฝะธั Selectel
  2๏ธโฃ  Cloud Platform โ Managed Databases โ ะฒะฐั ะบะปะฐััะตั
  3๏ธโฃ  ะะตัะตะนะดะธัะต ะฝะฐ ะฒะบะปะฐะดะบั ยซะะพะปัะทะพะฒะฐัะตะปะธยป
  4๏ธโฃ  ะะฐะนะดะธัะต ะฟะพะปัะทะพะฒะฐัะตะปั: auth_service_staging_app
  5๏ธโฃ  ะะฐะถะผะธัะต ะบะฝะพะฟะบั ัะดะฐะปะตะฝะธั (ะบะพัะทะธะฝะฐ)
  6๏ธโฃ  ะะพะดัะฒะตัะดะธัะต ัะดะฐะปะตะฝะธะต

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ ะฃะดะฐะปะตะฝะธะต ะทะฐะฒะตััะตะฝะพ!
```

---

#### ะะฐััะพะฒะพะต ัะพะทะดะฐะฝะธะต ััะตะผ

##### ะะปั ะฝะตัะบะพะปัะบะธั ัะตัะฒะธัะพะฒ ััะฐะทั

ะัะฟะพะปัะทัะนัะต ัะบัะธะฟั `create-all-staging-schemas.sh`:

```bash
chmod +x create-all-staging-schemas.sh
./create-all-staging-schemas.sh
```

ะกะบัะธะฟั ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพ ัะพะทะดะฐัั ััะตะผั ะดะปั ะฒัะตั ัะตัะฒะธัะพะฒ ะธะท ัะฟะธัะบะฐ:
- `auth_service`
- `profile_service`
- `project_service`
- `mentor_service`

**ะะตัะตะด ะทะฐะฟััะบะพะผ:**
1. ะฃะฑะตะดะธัะตัั, ััะพ ะฒัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ัะพะทะดะฐะฝั ะฒ Selectel
2. ะัะพะฒะตัััะต ัะฟะธัะพะบ ัะตัะฒะธัะพะฒ ะฒะฝัััะธ ัะบัะธะฟัะฐ

---

#### ะัะฟะพะปัะทะพะฒะฐะฝะธะต Secret ะฒ ะฟัะธะปะพะถะตะฝะธะธ

##### ะัะธะผะตั Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: auth-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
      - name: app
        image: your-registry/auth-service:latest
        env:
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: postgres-auth-service-staging-app
              key: host
        - name: DB_PORT
          valueFrom:
            secretKeyRef:
              name: postgres-auth-service-staging-app
              key: port
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: postgres-auth-service-staging-app
              key: dbname
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: postgres-auth-service-staging-app
              key: user
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-auth-service-staging-app
              key: password
        - name: DB_SCHEMA
          valueFrom:
            secretKeyRef:
              name: postgres-auth-service-staging-app
              key: schema
        - name: DB_SSLMODE
          value: "verify-ca"
        volumeMounts:
        - name: postgres-ca
          mountPath: /app/certs
          readOnly: true
      volumes:
      - name: postgres-ca
        configMap:
          name: postgres-ca-cert
```

---

#### ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะฒัััะฝัั

##### ะงะตัะตะท bastion pod

```bash
kubectl exec -it deployment/bastion -n bastion -- bash

# ะญะบัะฟะพัั ะฟะฐัะพะปั
export PGPASSWORD='your_password'

# ะะพะดะบะปััะตะฝะธะต
psql -h master.e9342be5-6813-4af4-aa03-5136361f9980.c.dbaas.selcloud.ru \
     -U auth_service_staging_app \
     -d db_main

# ะฃััะฐะฝะพะฒะบะฐ search_path
SET search_path TO 'auth_service_staging';

# ะัะพะฒะตัะบะฐ ัะตะบััะตะน ััะตะผั
SELECT current_schema();

# ะัะพะฒะตัะบะฐ ะฟัะฐะฒ
SELECT has_schema_privilege('auth_service_staging', 'CREATE');

# ะขะตัั ัะพะทะดะฐะฝะธั ัะฐะฑะปะธัั
CREATE TABLE test_table (id SERIAL PRIMARY KEY, name VARCHAR(50));
INSERT INTO test_table (name) VALUES ('test');
SELECT * FROM test_table;
DROP TABLE test_table;
```

---

#### ะัะฐะฒะฐ ะฟะพะปัะทะพะฒะฐัะตะปั (ะดะตัะฐะปะธ)

##### ะงัะพ ะผะพะถะตั ะฟะพะปัะทะพะฒะฐัะตะปั

โ **ะ ัะฒะพะตะน ััะตะผะต:**
- CREATE TABLE, INDEX, SEQUENCE, FUNCTION
- INSERT, SELECT, UPDATE, DELETE
- DROP ัะฒะพะธั ะพะฑัะตะบัะพะฒ
- ALTER ัะฒะพะธั ะพะฑัะตะบัะพะฒ

โ **ะกะธััะตะผะฝัะต:**
- ะงัะตะฝะธะต information_schema
- ะะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต db_main

##### ะงัะพ ะะ ะผะพะถะตั ะฟะพะปัะทะพะฒะฐัะตะปั

โ **ะะฐะฟัะตัะตะฝะพ:**
- CREATE SCHEMA (ัะพะทะดะฐะฝะธะต ะฝะพะฒัั ััะตะผ)
- CREATE USER / ROLE (ัะพะทะดะฐะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปะตะน)
- DROP SCHEMA public (ัะดะฐะปะตะฝะธะต ััะตะผั public)
- ะะพัััะฟ ะบ ะดััะณะธะผ ััะตะผะฐะผ (ะบัะพะผะต ัะฒะพะตะน)
- ะะทะผะตะฝะตะฝะธะต ะฝะฐัััะพะตะบ ะฑะฐะทั ะดะฐะฝะฝัั
- ะกัะฟะตัะฟะพะปัะทะพะฒะฐัะตะปััะบะธะต ะพะฟะตัะฐัะธะธ

##### ะะตัะฐะฝะธะทะผ ะธะทะพะปััะธะธ

```sql
-- ะัะฐะฒะฐ ะฝะฐ ัะฒะพั ััะตะผั
GRANT USAGE, CREATE ON SCHEMA {schema_name} TO {user};
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA {schema_name} TO {user};
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA {schema_name} TO {user};
GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA {schema_name} TO {user};

-- ะะฒัะพะผะฐัะธัะตัะบะธะต ะฟัะฐะฒะฐ ะฝะฐ ะฑัะดััะธะต ะพะฑัะตะบัั
ALTER DEFAULT PRIVILEGES IN SCHEMA {schema_name} GRANT ALL ON TABLES TO {user};
ALTER DEFAULT PRIVILEGES IN SCHEMA {schema_name} GRANT ALL ON SEQUENCES TO {user};
ALTER DEFAULT PRIVILEGES IN SCHEMA {schema_name} GRANT ALL ON FUNCTIONS TO {user};

-- ะะฐะฟัะตั ัะพะทะดะฐะฝะธั ััะตะผ
REVOKE CREATE ON DATABASE db_main FROM {user};

-- ะะฐะฟัะตั ะดะพัััะฟะฐ ะบ public
REVOKE ALL ON SCHEMA public FROM {user};
REVOKE ALL ON ALL TABLES IN SCHEMA public FROM {user};
```

---

#### ะกัะตะฝะฐัะธะธ ะธัะฟะพะปัะทะพะฒะฐะฝะธั

##### ะกัะตะฝะฐัะธะน 1: ะกะพะทะดะฐะฝะธะต ะฝะพะฒะพะน ะธะฝััะฐััััะบัััั

```bash
./create-schema.sh payment_service staging
```

1. ะกัะตะผะฐ `payment_service_staging` ะฑัะดะตั ัะพะทะดะฐะฝะฐ
2. ะั ัะพะทะดะฐะดะธัะต ะฟะพะปัะทะพะฒะฐัะตะปั `payment_service_staging_app` ะฒ Selectel
3. Secret `postgres-payment-service-staging-app` ะฑัะดะตั ัะพะทะดะฐะฝ
4. ะัะพะฒะตัััะต ะฟัะฐะฒะฐ: `./test-schema-permissions.sh payment_service staging`

---

##### ะกัะตะฝะฐัะธะน 2: ะะฑะฝะพะฒะปะตะฝะธะต ะฟะฐัะพะปั

```bash
./create-schema.sh auth_service staging
```

1. ะกะบัะธะฟั ะพะฑะฝะฐััะถะธั ัััะตััะฒััััั ััะตะผั โ ะฟัะพะดะพะปะถะธั
2. ะกะบัะธะฟั ะพะฑะฝะฐััะถะธั ัััะตััะฒัััะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั โ ะฟัะตะดะปะพะถะธั ะพะฑะฝะพะฒะธัั ะฟะฐัะพะปั
3. ะั ะฒะฒะตะดััะต ะฝะพะฒัะน ะฟะฐัะพะปั
4. ะะฑะฝะพะฒะธัะต ะฟะฐัะพะปั ะฒ ะฟะฐะฝะตะปะธ Selectel
5. Secret ะฑัะดะตั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพะฑะฝะพะฒะปัะฝ

---

##### ะกัะตะฝะฐัะธะน 3: ะะตัะตัะพะทะดะฐะฝะธะต Secret ะฑะตะท ะธะทะผะตะฝะตะฝะธะน

```bash
./create-schema.sh auth_service staging
```

1. ะกัะตะผะฐ ัััะตััะฒัะตั โ ะฟัะพะดะพะปะถะธัั? `y`
2. ะะพะปัะทะพะฒะฐัะตะปั ัััะตััะฒัะตั โ ะพะฑะฝะพะฒะธัั ะฟะฐัะพะปั? `n`
3. ะะฒะตะดะธัะต ัะตะบััะธะน ะฟะฐัะพะปั
4. Secret ัััะตััะฒัะตั โ ะพะฑะฝะพะฒะธัั? `y`
5. Secret ะฟะตัะตัะพะทะดะฐะฝ ั ัะตะผ ะถะต ะฟะฐัะพะปะตะผ

---

#### ะะพะผะฐะฝะดั ะดะปั ะฟัะพะฒะตัะบะธ

##### ะกะฟะธัะพะบ ัะพะทะดะฐะฝะฝัั ััะตะผ

```bash
kubectl exec -it deployment/bastion -n bastion -- psql -c "\dn"
```

##### ะกะฟะธัะพะบ ัะพะทะดะฐะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน

```bash
kubectl exec -it deployment/bastion -n bastion -- psql -c "\du"
```

##### ะกะฟะธัะพะบ Kubernetes Secrets

```bash
kubectl get secrets -n postgres | grep postgres-
```

##### ะัะพะฒะตัะบะฐ ะบะพะฝะบัะตัะฝะพะณะพ Secret

```bash
kubectl get secret postgres-auth-service-staging-app -n postgres -o yaml
```

##### ะัะพะฒะตัะบะฐ ะฟัะฐะฒ ะฟะพะปัะทะพะฒะฐัะตะปั

```bash
kubectl exec -it deployment/bastion -n bastion -- psql -c "\du auth_service_staging_app"
```

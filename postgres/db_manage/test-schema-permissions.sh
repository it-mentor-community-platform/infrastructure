#!/bin/bash

#############################################################################
# PostgreSQL User Permissions Tester (Selectel Edition)
#
# –û–ø–∏—Å–∞–Ω–∏–µ:
# –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è PostgreSQL:
# - READ/WRITE –¥–æ—Å—Ç—É–ø –∫ —Å–≤–æ–µ–π —Å—Ö–µ–º–µ
# - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥—Ä—É–≥–∏–º —Å—Ö–µ–º–∞–º
# - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
# ./test-schema-permissions.sh <service_name> <environment>
#
# –ü—Ä–∏–º–µ—Ä—ã:
# ./test-schema-permissions.sh auth_service staging
# ./test-schema-permissions.sh profile_service prod
#############################################################################

set -e

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

log_info() { echo -e "${BLUE}‚Ñπ${NC} $1"; }
log_success() { echo -e "${GREEN}‚úÖ${NC} $1"; }
log_warning() { echo -e "${YELLOW}‚ö†${NC} $1"; }
log_error() { echo -e "${RED}‚ùå${NC} $1"; }
log_test() { echo -e "${MAGENTA}üß™${NC} $1"; }

#############################################################################
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
#############################################################################

SERVICE_NAME=$1
ENVIRONMENT=$2

if [ -z "$SERVICE_NAME" ] || [ -z "$ENVIRONMENT" ]; then
    log_error "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤!"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./test-schema-permissions.sh <service_name> <environment>"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  ./test-schema-permissions.sh auth_service staging"
    echo "  ./test-schema-permissions.sh profile_service prod"
    echo ""
    exit 1
fi

if [ "$ENVIRONMENT" != "staging" ] && [ "$ENVIRONMENT" != "prod" ]; then
    log_error "–û–∫—Ä—É–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 'staging' –∏–ª–∏ 'prod'"
    exit 1
fi

#############################################################################
# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º—ë–Ω
#############################################################################

SCHEMA_NAME="${SERVICE_NAME}_${ENVIRONMENT}"
USER_APP="${SERVICE_NAME}_${ENVIRONMENT}_app"
SERVICE_NAME_DASHED=$(echo "$SERVICE_NAME" | tr '_' '-')
SECRET_NAME="postgres-${SERVICE_NAME_DASHED}-${ENVIRONMENT}-app"
K8S_NAMESPACE="postgres"

echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
log_info "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${CYAN}${USER_APP}${NC}"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
echo "üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Ç–∞:"
echo ""
echo -e "  –°—Ö–µ–º–∞:        ${CYAN}${SCHEMA_NAME}${NC}"
echo -e "  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${CYAN}${USER_APP}${NC}"
echo -e "  Secret:       ${CYAN}${SECRET_NAME}${NC}"
echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

#############################################################################
# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Kubernetes Secret
#############################################################################

log_info "–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Kubernetes Secret..."

if ! kubectl get secret "$SECRET_NAME" -n "$K8S_NAMESPACE" &>/dev/null; then
    log_error "Secret '$SECRET_NAME' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ namespace '$K8S_NAMESPACE'"
    exit 1
fi

PGHOST=$(kubectl get secret "$SECRET_NAME" -n "$K8S_NAMESPACE" -o jsonpath='{.data.host}' | base64 -d)
PGPORT=$(kubectl get secret "$SECRET_NAME" -n "$K8S_NAMESPACE" -o jsonpath='{.data.port}' | base64 -d)
PGDATABASE=$(kubectl get secret "$SECRET_NAME" -n "$K8S_NAMESPACE" -o jsonpath='{.data.dbname}' | base64 -d)
PGUSER=$(kubectl get secret "$SECRET_NAME" -n "$K8S_NAMESPACE" -o jsonpath='{.data.user}' | base64 -d)
PGPASSWORD=$(kubectl get secret "$SECRET_NAME" -n "$K8S_NAMESPACE" -o jsonpath='{.data.password}' | base64 -d)
PGSCHEMA=$(kubectl get secret "$SECRET_NAME" -n "$K8S_NAMESPACE" -o jsonpath='{.data.schema}' | base64 -d)

if [ -z "$PGHOST" ] || [ -z "$PGPASSWORD" ]; then
    log_error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Secret"
    exit 1
fi

log_success "–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ Secret"
echo "  Host: $PGHOST"
echo "  Database: $PGDATABASE"
echo "  User: $PGUSER"
echo "  Schema: $PGSCHEMA"
echo ""

#############################################################################
# –°—á—ë—Ç—á–∏–∫–∏ —Ç–µ—Å—Ç–æ–≤
#############################################################################

TESTS_PASSED=0
TESTS_FAILED=0
TESTS_TOTAL=0

#############################################################################
# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞
#############################################################################

run_test() {
    local TEST_NAME="$1"
    local SQL_COMMAND="$2"
    local EXPECTED_SUCCESS="$3"  # true –∏–ª–∏ false

    TESTS_TOTAL=$((TESTS_TOTAL + 1))
    log_test "–¢–µ—Å—Ç $TESTS_TOTAL: $TEST_NAME"

    RESULT=$(kubectl exec -i deployment/bastion -n bastion -- bash -c \
        "PGPASSWORD='$PGPASSWORD' psql -h '$PGHOST' -p '$PGPORT' -U '$PGUSER' -d '$PGDATABASE' -tAc \"$SQL_COMMAND\" 2>&1" || echo "ERROR")

    if [ "$EXPECTED_SUCCESS" = "true" ]; then
        if [[ "$RESULT" != *"ERROR"* ]] && [[ "$RESULT" != *"permission denied"* ]] && [[ "$RESULT" != *"does not exist"* ]]; then
            log_success "–ü—Ä–æ–π–¥–µ–Ω"
            TESTS_PASSED=$((TESTS_PASSED + 1))
            return 0
        else
            log_error "–ü—Ä–æ–≤–∞–ª–µ–Ω: $RESULT"
            TESTS_FAILED=$((TESTS_FAILED + 1))
            return 1
        fi
    else
        # –û–∂–∏–¥–∞–µ–º –ø—Ä–æ–≤–∞–ª
        if [[ "$RESULT" == *"permission denied"* ]] || [[ "$RESULT" == *"must be owner"* ]] || [[ "$RESULT" == *"does not exist"* ]]; then
            log_success "–ü—Ä–æ–π–¥–µ–Ω (–¥–æ—Å—Ç—É–ø –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–ø—Ä–µ—â—ë–Ω)"
            TESTS_PASSED=$((TESTS_PASSED + 1))
            return 0
        else
            log_error "–ü—Ä–æ–≤–∞–ª–µ–Ω: –¥–æ—Å—Ç—É–ø –Ω–µ –±—ã–ª –∑–∞–ø—Ä–µ—â—ë–Ω"
            TESTS_FAILED=$((TESTS_FAILED + 1))
            return 1
        fi
    fi
}

#############################################################################
# –¢–µ—Å—Ç 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
#############################################################################

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üîç –ö–∞—Ç–µ–≥–æ—Ä–∏—è 1: –ë–∞–∑–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

run_test "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö" "SELECT current_user;" true
run_test "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º—ã" "SET search_path TO '$SCHEMA_NAME'; SELECT current_schema();" true

echo ""

#############################################################################
# –¢–µ—Å—Ç 2: READ/WRITE –ø—Ä–∞–≤–∞ –≤ —Å–≤–æ–µ–π —Å—Ö–µ–º–µ
#############################################################################

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üîç –ö–∞—Ç–µ–≥–æ—Ä–∏—è 2: READ/WRITE –ø—Ä–∞–≤–∞ –≤ —Å—Ö–µ–º–µ $SCHEMA_NAME"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
run_test "CREATE TABLE –≤ —Å–≤–æ–µ–π —Å—Ö–µ–º–µ" \
    "SET search_path TO '$SCHEMA_NAME'; CREATE TABLE test_permissions_table (id SERIAL PRIMARY KEY, name VARCHAR(50), created_at TIMESTAMP DEFAULT NOW());" true

# –í—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
run_test "INSERT –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü—É" \
    "SET search_path TO '$SCHEMA_NAME'; INSERT INTO test_permissions_table (name) VALUES ('test_user_1'), ('test_user_2');" true

# –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
run_test "SELECT –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã" \
    "SET search_path TO '$SCHEMA_NAME'; SELECT COUNT(*) FROM test_permissions_table;" true

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
run_test "UPDATE –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ" \
    "SET search_path TO '$SCHEMA_NAME'; UPDATE test_permissions_table SET name = 'updated_user' WHERE name = 'test_user_1';" true

# –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
run_test "DELETE –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã" \
    "SET search_path TO '$SCHEMA_NAME'; DELETE FROM test_permissions_table WHERE name = 'test_user_2';" true

# –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
run_test "CREATE INDEX –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ" \
    "SET search_path TO '$SCHEMA_NAME'; CREATE INDEX idx_test_name ON test_permissions_table(name);" true

# –£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
run_test "DROP TABLE –≤ —Å–≤–æ–µ–π —Å—Ö–µ–º–µ" \
    "SET search_path TO '$SCHEMA_NAME'; DROP TABLE test_permissions_table;" true

echo ""

#############################################################################
# –¢–µ—Å—Ç 3: –†–∞–±–æ—Ç–∞ —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è–º–∏ (sequences)
#############################################################################

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üîç –ö–∞—Ç–µ–≥–æ—Ä–∏—è 3: –†–∞–±–æ—Ç–∞ —Å SEQUENCES"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

run_test "CREATE SEQUENCE –≤ —Å–≤–æ–µ–π —Å—Ö–µ–º–µ" \
    "SET search_path TO '$SCHEMA_NAME'; CREATE SEQUENCE test_seq START 1;" true

run_test "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SEQUENCE" \
    "SET search_path TO '$SCHEMA_NAME'; SELECT nextval('test_seq');" true

run_test "DROP SEQUENCE –≤ —Å–≤–æ–µ–π —Å—Ö–µ–º–µ" \
    "SET search_path TO '$SCHEMA_NAME'; DROP SEQUENCE test_seq;" true

echo ""

#############################################################################
# –¢–µ—Å—Ç 4: –ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥—Ä—É–≥–∏–º —Å—Ö–µ–º–∞–º
#############################################################################

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üîç –ö–∞—Ç–µ–≥–æ—Ä–∏—è 4: –ò–∑–æ–ª—è—Ü–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö —Å—Ö–µ–º"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥—Ä—É–≥–∏—Ö —Å—Ö–µ–º (–Ω–µ —Å–≤–æ—è, –Ω–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ)
OTHER_SCHEMAS=$(kubectl exec -i deployment/bastion -n bastion -- bash -c \
  "PGPASSWORD=$PGPASSWORD psql -h $PGHOST -p $PGPORT -U $PGUSER -d $PGDATABASE -tAc \
  \"SELECT nspname FROM pg_namespace 
   WHERE nspname NOT LIKE 'pg_%' 
   AND nspname NOT IN ('$SCHEMA_NAME', 'information_schema', 'public') 
   LIMIT 3;\" 2>/dev/null" | tr -d ' ')

if [ -n "$OTHER_SCHEMAS" ]; then
    log_info "–ù–∞–π–¥–µ–Ω—ã –¥—Ä—É–≥–∏–µ —Å—Ö–µ–º—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–ª—è—Ü–∏–∏"
    echo ""

    while IFS= read -r OTHER_SCHEMA; do
        if [ -n "$OTHER_SCHEMA" ]; then
            run_test "–ü–æ–ø—ã—Ç–∫–∞ CREATE TABLE –≤ —Å—Ö–µ–º–µ $OTHER_SCHEMA (–¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è)" \
                "CREATE TABLE \"$OTHER_SCHEMA\".unauthorized_table (id INT);" false

            # –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑ –¥—Ä—É–≥–æ–π —Å—Ö–µ–º—ã
            run_test "–ü–æ–ø—ã—Ç–∫–∞ SELECT –∏–∑ —Å—Ö–µ–º—ã $OTHER_SCHEMA (–¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è)" \
                "SET search_path TO '$OTHER_SCHEMA'; SELECT * FROM information_schema.tables WHERE table_schema = '$OTHER_SCHEMA' LIMIT 1;" false
        fi
    done <<< "$OTHER_SCHEMAS"
else
    log_warning "–î—Ä—É–≥–∏—Ö —Å—Ö–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Ç–µ—Å—Ç—ã –∏–∑–æ–ª—è—Ü–∏–∏ –ø—Ä–æ–ø—É—â–µ–Ω—ã"
fi

echo ""

#############################################################################
# –¢–µ—Å—Ç 5: –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ö–µ–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è)
#############################################################################

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üîç –ö–∞—Ç–µ–≥–æ—Ä–∏—è 5: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

run_test "–ü–æ–ø—ã—Ç–∫–∞ CREATE SCHEMA (–¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è)" \
    "CREATE SCHEMA unauthorized_schema;" false

run_test "–ü–æ–ø—ã—Ç–∫–∞ CREATE USER (–¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è)" \
    "CREATE USER unauthorized_user WITH PASSWORD 'test123';" false

# –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±—Ä–∞–Ω IF EXISTS, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—à–∏–±–∫—É permission denied
run_test "–ü–æ–ø—ã—Ç–∫–∞ DROP —Å—Ö–µ–º—ã public (–¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è)" \
    "DROP SCHEMA public CASCADE;" false

echo ""

#############################################################################
# –¢–µ—Å—Ç 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–Ω—ã–º —Ç–∞–±–ª–∏—Ü–∞–º
#############################################################################

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üîç –ö–∞—Ç–µ–≥–æ—Ä–∏—è 6: –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è –∫ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

run_test "–ß—Ç–µ–Ω–∏–µ —Å–≤–æ–µ–π —Å—Ö–µ–º—ã –∏–∑ information_schema" \
    "SELECT schema_name FROM information_schema.schemata WHERE schema_name = '$SCHEMA_NAME';" true

run_test "–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö —Ç–∞–±–ª–∏—Ü" \
    "SELECT table_name FROM information_schema.tables WHERE table_schema = '$SCHEMA_NAME';" true

echo ""

#############################################################################
# –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
#############################################################################

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
echo -e "  –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: ${CYAN}${TESTS_TOTAL}${NC}"
echo -e "  –ü—Ä–æ–π–¥–µ–Ω–æ:     ${GREEN}${TESTS_PASSED}${NC}"
echo -e "  –ü—Ä–æ–≤–∞–ª–µ–Ω–æ:    ${RED}${TESTS_FAILED}${NC}"
echo ""

if [ $TESTS_FAILED -eq 0 ]; then
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    log_success "–í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´! ‚ú®"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    echo "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ:"
    echo "  ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–≤–æ–µ–π —Å—Ö–µ–º–µ"
    echo "  ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥—Ä—É–≥–∏–º —Å—Ö–µ–º–∞–º"
    echo "  ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å—Ö–µ–º—ã/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
    echo "  ‚Ä¢ –ü—Ä–∞–≤–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∏–Ω—Ü–∏–ø—É least privilege"
    echo ""
    exit 0
else
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    log_error "–ù–ï–ö–û–¢–û–†–´–ï –¢–ï–°–¢–´ –ü–†–û–í–ê–õ–ï–ù–´!"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    log_warning "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å—Ö–µ–º—ã"
    echo ""
    exit 1
fi

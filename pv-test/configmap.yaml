apiVersion: v1
kind: ConfigMap
metadata:
  name: pv-test-nginx
  namespace: pv-test
data:
  default.conf: |
    server {
      listen 80;
      server_name _;

      location / {
        root /usr/share/nginx/html;
        index index.html;
      }

      location /persistent/ {
        alias /usr/share/nginx/html/persistent/;
        autoindex off;
      }

      location /temporary/ {
        alias /usr/share/nginx/html/temporary/;
        autoindex off;
      }
    }

  index.html: |
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>PV Test - Selectel</title>
      <meta http-equiv="refresh" content="5">
      <style>
        body { 
          font-family: monospace; 
          max-width: 700px; 
          margin: 40px auto; 
          padding: 20px;
          background: #fafafa;
        }
        h1 { 
          border-bottom: 2px solid #333; 
          padding-bottom: 10px; 
        }
        .disk { 
          border: 1px solid #ccc; 
          padding: 20px; 
          margin: 20px 0; 
          background: white;
        }
        .disk h2 { 
          margin-top: 0; 
        }
        .status { 
          font-size: 24px; 
          font-weight: bold; 
          padding: 10px; 
          margin: 10px 0;
        }
        .info { 
          background: #f0f0f0; 
          padding: 3px 6px; 
          margin: 5px 0; 
          display: block;
        }
        code { 
          background: #e0e0e0; 
          padding: 2px 4px; 
        }
        .test-section {
          border-top: 1px solid #ccc;
          padding-top: 20px;
          margin-top: 30px;
        }
        .test-step {
          margin: 15px 0;
          padding: 12px;
          background: #f9f9f9;
          border-left: 3px solid #666;
        }
        .test-step strong {
          display: block;
          margin-bottom: 8px;
          color: #333;
        }
      </style>
    </head>
    <body>
      <h1>PV Test: Retain vs Delete</h1>

      <div class="disk">
        <h2>Persistent Volume (Retain)</h2>
        <div class="status">
          <iframe src="/persistent/result.txt" style="border:none;width:100%;height:30px;"></iframe>
        </div>
        <span class="info">File: <code>/data/persistent/test.txt</code></span>
        <span class="info">Checksum: <code>/data/persistent/checksum.txt</code></span>
        <span class="info">Policy: –î–∏—Å–∫ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ Selectel –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è PVC</span>
      </div>

      <div class="disk">
        <h2>Temporary Volume (Delete)</h2>
        <div class="status">
          <iframe src="/temporary/result.txt" style="border:none;width:100%;height:30px;"></iframe>
        </div>
        <span class="info">File: <code>/data/temporary/test.txt</code></span>
        <span class="info">Checksum: <code>/data/temporary/checksum.txt</code></span>
        <span class="info">Policy: –î–∏—Å–∫ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ Selectel –≤–º–µ—Å—Ç–µ —Å PVC</span>
      </div>

      <div class="test-section">
        <h3>üß™ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</h3>
        
        <div class="test-step">
          <strong>–®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</strong>
          <code>kubectl apply -f job-init.yaml</code><br>
          <code>kubectl wait --for=condition=complete job/pv-init-once -n pv-test --timeout=60s</code><br>
          <code>kubectl delete pod -n pv-test -l app=pv-test</code><br>
          <small>–†–µ–∑—É–ª—å—Ç–∞—Ç: –æ–±–∞ –¥–∏—Å–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç OK</small>
        </div>
        
        <div class="test-step">
          <strong>–®–∞–≥ 2: –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –¥–∏—Å–∫–æ–≤</strong>
          <code>kubectl get pv -o wide</code><br>
          <small>–ó–∞–ø–æ–º–Ω–∏—Ç–µ volumeHandle persistent –¥–∏—Å–∫–∞ (ID –≤ Selectel)</small>
        </div>
        
        <div class="test-step">
          <strong>–®–∞–≥ 3: –£–¥–∞–ª–µ–Ω–∏–µ PVC (–≥–ª–∞–≤–Ω—ã–π —Ç–µ—Å—Ç!)</strong>
          <code>kubectl delete deployment pv-test -n pv-test</code><br>
          <code>kubectl delete pvc pv-test-persistent pv-test-temporary -n pv-test</code><br>
          <code>kubectl get pv</code><br>
          <small>–†–µ–∑—É–ª—å—Ç–∞—Ç: Persistent PV –≤ Released, Temporary PV —É–¥–∞–ª—ë–Ω</small>
        </div>
        
        <div class="test-step">
          <strong>–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–∫–æ–≤ –≤ Selectel</strong>
          <small>–û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–Ω–µ–ª—å Selectel ‚Üí –û–±–ª–∞—á–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ ‚Üí –î–∏—Å–∫–∏</small><br>
          <small>‚úÖ Persistent –¥–∏—Å–∫ –æ—Å—Ç–∞–ª—Å—è</small><br>
          <small>‚ùå Temporary –¥–∏—Å–∫ —É–¥–∞–ª—ë–Ω</small>
        </div>
        
        <div class="test-step">
          <strong>–®–∞–≥ 5: –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å –Ω–æ–≤—ã–º–∏ –¥–∏—Å–∫–∞–º–∏</strong>
          <code>kubectl apply -f pvc-persistent.yaml</code><br>
          <code>kubectl apply -f pvc-temporary.yaml</code><br>
          <code>kubectl apply -f deployment.yaml</code><br>
          <small>–†–µ–∑—É–ª—å—Ç–∞—Ç: –æ–±–∞ –¥–∏—Å–∫–∞ ERROR (–Ω–æ–≤—ã–µ –ø—É—Å—Ç—ã–µ –¥–∏—Å–∫–∏)</small>
        </div>
        
        <div class="test-step">
          <strong>–®–∞–≥ 6: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Retain –¥–∏—Å–∫–∞</strong>
          <code># –°–æ–∑–¥–∞—ë–º PV –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –¥–∏—Å–∫–∞ –≤ Selectel</code><br>
          <code>cat &lt;&lt;EOF | kubectl apply -f -</code><br>
          <code>apiVersion: v1</code><br>
          <code>kind: PersistentVolume</code><br>
          <code>metadata:</code><br>
          <code>  name: pv-restored</code><br>
          <code>spec:</code><br>
          <code>  capacity:</code><br>
          <code>    storage: 1Gi</code><br>
          <code>  accessModes: [ReadWriteOnce]</code><br>
          <code>  persistentVolumeReclaimPolicy: Retain</code><br>
          <code>  storageClassName: selectel-hdd-retain</code><br>
          <code>  csi:</code><br>
          <code>    driver: cinder.csi.openstack.org</code><br>
          <code>    fsType: ext4</code><br>
          <code>    volumeHandle: &lt;ID_–î–ò–°–ö–ê_–ò–ó_SELECTEL&gt;</code><br>
          <code>EOF</code>
        </div>
        
        <div class="test-step">
          <strong>–®–∞–≥ 7: –ü—Ä–∏–≤—è–∑–∫–∞ PVC –∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–º—É PV</strong>
          <code>kubectl delete deployment pv-test -n pv-test</code><br>
          <code>kubectl delete pvc pv-test-persistent -n pv-test</code><br>
          <code># –°–æ–∑–¥–∞—ë–º PVC —Å volumeName: pv-restored</code><br>
          <code>kubectl apply -f pvc-persistent-restored.yaml</code><br>
          <code>kubectl apply -f deployment.yaml</code>
        </div>
        
        <div class="test-step">
          <strong>–®–∞–≥ 8: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞</strong>
          <small>‚úÖ Persistent: OK (–¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ –¥–∏—Å–∫–∞!)</small><br>
          <small>‚ùå Temporary: ERROR (–¥–∏—Å–∫ –±—ã–ª —É–¥–∞–ª—ë–Ω –Ω–∞–≤—Å–µ–≥–¥–∞)</small>
        </div>
      </div>
      
      <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-left: 4px solid #4caf50;">
        <strong>–í—ã–≤–æ–¥:</strong> Retain –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è PVC,
        Delete —É–¥–∞–ª—è–µ—Ç –¥–∏—Å–∫ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.
      </div>
    </body>
    </html>
